<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>本日のトレーニング | gymnote</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
</head>

<body>
    <div class="container">

        <div class="nav">
            <div class="brand">
                <div class="logo">G</div>
                <div>
                    gymnote
                    <small th:text="|こんにちは、${displayName}さん|">こんにちは、ユーザーさん</small>
                </div>
            </div>
            <div class="actions">
                <a class="btn" href="/">ホーム</a>
                <a class="btn" href="/workouts">過去のトレーニング/日付</a>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h1 class="h1">本日のトレーニング</h1>
                <p class="sub">種目ごとに「重量 × 回数」をセットとして追加</p>
            </div>

            <div class="card-body">
                <div class="alert error" th:if="${errorMessage}" th:text="${errorMessage}"></div>

                <form th:action="@{/workouts}" th:object="${workoutForm}" method="post" data-workout-form>
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <!-- 日付：カレンダー選択のみ -->
                    <div class="field">
                        <label>日付（カレンダー選択）</label>

                        <div class="date-row">
                            <input id="workoutDate" type="date" th:field="*{workoutDate}" required inputmode="none"
                                autocomplete="off">
                            <button class="btn" type="button" id="openDatePicker">📅 選択</button>
                        </div>

                        <div class="small-link" style="margin-top:6px;">
                            ※ 文字入力はできません。カレンダーから選択してください。
                        </div>
                    </div>


                    <!-- メモ：3行 -->
                    <div class="field">
                        <label>メモ（任意）</label>
                        <textarea class="textarea" rows="3" th:field="*{note}" placeholder="例）胸の日、フォーム意識など"></textarea>
                    </div>

                    <!-- ボタン群 -->
                    <div class="action-row">
                        <button id="addExerciseBtn" class="btn btn-primary btn-lg" type="button">＋ 種目ブロック追加</button>
                        <a href="/exercises/new" class="btn" data-save-draft-link>新規（種目追加）</a>
                        <a class="btn btn-ghost btn-lg" href="/exercises" data-save-draft-link>既存種目の修正/削除</a>
                    </div>



                    <select id="bodyPartOptionsSource" style="display:none;">
                        <option value="">-- 選択 --</option>
                        <option th:each="bp : ${bodyParts}" th:value="${bp.name()}" th:text="${bp.label}">
                            胸
                        </option>
                    </select>

                    <!-- 種目ブロック一覧 -->
                    <div id="exerciseContainer" style="display:grid; gap:12px; margin-top:12px;">
                        <div class="exercise-block tile" style="grid-column: span 12; padding:14px;"
                            th:each="ex, exSt : *{exerciseEntries}">

                            <div class="exercise-top">

                                <!-- カテゴリ（部位） -->
                                <div class="field" style="min-width:220px;">
                                    <label>カテゴリ</label>
                                    <select class="select category-select" required>
                                        <option value="">-- 選択 --</option>
                                        <option th:each="bp : ${bodyParts}" th:value="${bp.name()}"
                                            th:text="${bp.label}">
                                            胸
                                        </option>
                                    </select>
                                </div>

                                <!-- 種目 -->
                                <div class="field" style="min-width:280px;">
                                    <label>種目</label>
                                    <select class="select exercise-select"
                                        th:field="*{exerciseEntries[__${exSt.index}__].exerciseId}" required disabled>
                                        <option value="">-- まずカテゴリを選択 --</option>

                                        <option th:each="m : ${exercises}" th:value="${m.id}" th:text="${m.name}"
                                            th:attr="data-bodypart=${m.bodyPart.name()}">
                                            ベンチプレス
                                        </option>
                                    </select>
                                </div>

                                <!-- 統計表示 -->
                                <div class="mini-stats">
                                    <div class="mini-pill">
                                        セット数：<span class="set-count">0</span>
                                    </div>
                                </div>

                                <button class="btn btn-danger" type="button" data-remove-exercise>削除</button>
                            </div>


                            <!-- セット行 -->
                            <div class="sets" style="display:grid; gap:10px; margin-top:10px;">
                                <div class="set-row" th:each="s, sSt : *{exerciseEntries[__${exSt.index}__].sets}">
                                    <div class="set-grid">
                                        <div class="field">
                                            <label>重量(kg)</label>
                                            <input type="number" step="0.5" min="0"
                                                th:field="*{exerciseEntries[__${exSt.index}__].sets[__${sSt.index}__].weight}"
                                                placeholder="58.0">
                                        </div>
                                        <div class="field">
                                            <label>回数</label>
                                            <input type="number" min="0"
                                                th:field="*{exerciseEntries[__${exSt.index}__].sets[__${sSt.index}__].reps}"
                                                placeholder="10">
                                        </div>

                                        <button class="btn btn-danger" type="button" data-remove-set>削除</button>
                                    </div>
                                </div>
                            </div>

                            <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
                                <button class="btn" type="button" data-add-set>＋ セット追加（重量×回数）</button>
                            </div>

                        </div>
                    </div>

                    <!-- template: 種目ブロック -->
                    <template id="exerciseTemplate">
                        <div class="exercise-block tile" style="grid-column: span 12; padding:14px;">
                            <div class="exercise-top">

                                <div class="field" style="min-width:220px;">
                                    <label>カテゴリ</label>
                                    <select class="select category-select" required>
                                        <option value="">-- 選択 --</option>
                                        <!-- JSでoption複製 -->
                                    </select>
                                </div>

                                <div class="field" style="min-width:280px;">
                                    <label>種目</label>
                                    <select class="select exercise-select" name="exerciseEntries[__E__].exerciseId"
                                        required disabled>
                                        <!-- JSでoption複製 -->
                                    </select>
                                </div>

                                <div class="mini-stats">
                                    <div class="mini-pill">セット数：<span class="set-count">0</span></div>
                                </div>

                                <button class="btn btn-danger" type="button" data-remove-exercise>削除</button>
                            </div>

                            <div class="sets" style="display:grid; gap:10px; margin-top:10px;"></div>

                            <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
                                <button class="btn" type="button" data-add-set>＋ セット追加（重量×回数）</button>
                            </div>
                        </div>
                    </template>

                    <!-- template: セット行 -->
                    <template id="setTemplate">
                        <div class="set-row">
                            <div class="set-grid">
                                <div class="field">
                                    <label>重量(kg)</label>
                                    <input type="number" step="0.5" min="0"
                                        name="exerciseEntries[__E__].sets[__S__].weight" placeholder="58.0">
                                </div>
                                <div class="field">
                                    <label>回数</label>
                                    <input type="number" min="0" name="exerciseEntries[__E__].sets[__S__].reps"
                                        placeholder="10">
                                </div>
                                <button class="btn btn-danger" type="button" data-remove-set>削除</button>
                            </div>
                        </div>
                    </template>

                    <button type="submit" data-clear-draft-on-submit class="btn btn-primary">
                        保存
                    </button>

                </form>
            </div>
        </div>

    </div>
    <script th:src="@{/js/app.js}"></script>
</body>

</html>
